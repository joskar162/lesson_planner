{% extends 'base.html' %}
{% block content %}
<div class="container">
    <h2>Generate Lesson Plan</h2>
    <form id="generate-form" method="post">
        {% csrf_token %}
        <label for="subject">Subject:</label>
        <input type="text" id="subject" name="subject" required>

        <label for="grade">Grade/form:</label>
        <input type="text" id="grade" name="grade" required>

        <label for="topic">Topic:</label>
        <input type="text" id="topic" name="topic" required>

        <label for="duration">Duration (minutes):</label>
        <input type="number" id="duration" name="duration" required>

        <label for="teacher_actions">Teacher actions (optional):</label>
        <textarea id="teacher_actions" name="teacher_actions" rows="4" placeholder="Describe what the teacher will do during activities (e.g. 'Model step-by-step, ask guiding questions')."></textarea>

        <div style="display:flex; gap:8px; align-items:center;">
          <button type="submit" name="generate" class="btn">Generate Lesson Plan</button>
          <button type="submit" name="download_pdf" class="btn">Generate & Download PDF</button>
          <button type="submit" name="download_docx" class="btn">Generate & Download DOCX</button>
        </div>
    </form>

    {% if lesson_plan %}
    <div class="lesson-plan output">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Generated Lesson Plan</h3>
            <div>
              <button id="copy-plan" class="btn small" type="button">Copy</button>
            </div>
        </div>
        <pre id="generated-pre" style="display:none">{{ lesson_plan }}</pre>
        <div id="react-root" data-plan="{{ lesson_plan|escapejs }}"></div>
        <!-- Minimal React widget (no build step) -->
        <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script type="text/babel">
          const e = React.createElement;

          function PlanViewer(props) {
            const [copied, setCopied] = React.useState(false);
            const plan = props.plan || '';

            function copyText() {
              navigator.clipboard.writeText(plan).then(()=>{
                setCopied(true);
                setTimeout(()=>setCopied(false),2000);
              });
            }

            return (
              <div>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                  <h3>Generated Lesson Plan (React)</h3>
                  <div>
                    <button className="btn small" onClick={copyText}>{copied ? 'Copied' : 'Copy'}</button>
                  </div>
                </div>
                <pre style={{whiteSpace:'pre-wrap', fontFamily:'monospace'}}>{plan}</pre>
              </div>
            );
          }

          (function mount(){
            const root = document.getElementById('react-root');
            if(!root) return;
            const raw = root.dataset.plan || '';
            ReactDOM.createRoot(root).render(React.createElement(PlanViewer, {plan: raw}));
          })();
        </script>
        <div style="margin-top:10px;">
          {% if lesson_plan_id %}
            <a class="btn small" href="{% url 'lesson_pdf' lesson_plan_id %}" download="lessonplan_{{ lesson_plan_id }}.pdf" target="_blank" rel="noopener">Download as PDF</a>
            <a class="btn small" href="{% url 'lesson_docx' lesson_plan_id %}" download="lessonplan_{{ lesson_plan_id }}.docx" target="_blank" rel="noopener">Download as DOCX</a>
          {% else %}
            <!-- If no id available, offer instructions -->
            <p>If you'd like a PDF, save the plan then use the download button next to a saved plan.</p>
          {% endif %}
        </div>
    </div>
    {% endif %}

    <hr>
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3>Your recent lesson plans</h3>
      <button class="toggle-recent btn small" data-target="recent-list">Hide recent plans</button>
    </div>
    <div id="recent-list">
      {% for lp in recent_plans %}
        <div class="output">
          <strong>{{ lp.subject }} â€” {{ lp.topic }}</strong>
          <pre>{{ lp.content }}</pre>
          <small>Saved: {{ lp.created }}</small>
          <div style="margin-top:6px;">
            <a class="btn small" href="{% url 'lesson_pdf' lp.id %}" download="lessonplan_{{ lp.id }}.pdf" target="_blank" rel="noopener">Download PDF</a>
            <a class="btn small" href="{% url 'lesson_docx' lp.id %}" download="lessonplan_{{ lp.id }}.docx" target="_blank" rel="noopener">Download DOCX</a>
          </div>
        </div>
      {% empty %}
        <p>No saved plans yet.</p>
      {% endfor %}
    </div>
</div>
{% endblock %}